!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.background=t():e.background=t()}(this,(function(){return(()=>{var e={961:(e,t,s)=>{var n,i=function(){var e=String.fromCharCode,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",n={};function i(e,t){if(!n[e]){n[e]={};for(var s=0;s<e.length;s++)n[e][e.charAt(s)]=s}return n[e][t]}var a={compressToBase64:function(e){if(null==e)return"";var s=a._compress(e,6,(function(e){return t.charAt(e)}));switch(s.length%4){default:case 0:return s;case 1:return s+"===";case 2:return s+"==";case 3:return s+"="}},decompressFromBase64:function(e){return null==e?"":""==e?null:a._decompress(e.length,32,(function(s){return i(t,e.charAt(s))}))},compressToUTF16:function(t){return null==t?"":a._compress(t,15,(function(t){return e(t+32)}))+" "},decompressFromUTF16:function(e){return null==e?"":""==e?null:a._decompress(e.length,16384,(function(t){return e.charCodeAt(t)-32}))},compressToUint8Array:function(e){for(var t=a.compress(e),s=new Uint8Array(2*t.length),n=0,i=t.length;n<i;n++){var r=t.charCodeAt(n);s[2*n]=r>>>8,s[2*n+1]=r%256}return s},decompressFromUint8Array:function(t){if(null==t)return a.decompress(t);for(var s=new Array(t.length/2),n=0,i=s.length;n<i;n++)s[n]=256*t[2*n]+t[2*n+1];var r=[];return s.forEach((function(t){r.push(e(t))})),a.decompress(r.join(""))},compressToEncodedURIComponent:function(e){return null==e?"":a._compress(e,6,(function(e){return s.charAt(e)}))},decompressFromEncodedURIComponent:function(e){return null==e?"":""==e?null:(e=e.replace(/ /g,"+"),a._decompress(e.length,32,(function(t){return i(s,e.charAt(t))})))},compress:function(t){return a._compress(t,16,(function(t){return e(t)}))},_compress:function(e,t,s){if(null==e)return"";var n,i,a,r={},o={},u="",d="",c="",l=2,g=3,h=2,f=[],p=0,v=0;for(a=0;a<e.length;a+=1)if(u=e.charAt(a),Object.prototype.hasOwnProperty.call(r,u)||(r[u]=g++,o[u]=!0),d=c+u,Object.prototype.hasOwnProperty.call(r,d))c=d;else{if(Object.prototype.hasOwnProperty.call(o,c)){if(c.charCodeAt(0)<256){for(n=0;n<h;n++)p<<=1,v==t-1?(v=0,f.push(s(p)),p=0):v++;for(i=c.charCodeAt(0),n=0;n<8;n++)p=p<<1|1&i,v==t-1?(v=0,f.push(s(p)),p=0):v++,i>>=1}else{for(i=1,n=0;n<h;n++)p=p<<1|i,v==t-1?(v=0,f.push(s(p)),p=0):v++,i=0;for(i=c.charCodeAt(0),n=0;n<16;n++)p=p<<1|1&i,v==t-1?(v=0,f.push(s(p)),p=0):v++,i>>=1}0==--l&&(l=Math.pow(2,h),h++),delete o[c]}else for(i=r[c],n=0;n<h;n++)p=p<<1|1&i,v==t-1?(v=0,f.push(s(p)),p=0):v++,i>>=1;0==--l&&(l=Math.pow(2,h),h++),r[d]=g++,c=String(u)}if(""!==c){if(Object.prototype.hasOwnProperty.call(o,c)){if(c.charCodeAt(0)<256){for(n=0;n<h;n++)p<<=1,v==t-1?(v=0,f.push(s(p)),p=0):v++;for(i=c.charCodeAt(0),n=0;n<8;n++)p=p<<1|1&i,v==t-1?(v=0,f.push(s(p)),p=0):v++,i>>=1}else{for(i=1,n=0;n<h;n++)p=p<<1|i,v==t-1?(v=0,f.push(s(p)),p=0):v++,i=0;for(i=c.charCodeAt(0),n=0;n<16;n++)p=p<<1|1&i,v==t-1?(v=0,f.push(s(p)),p=0):v++,i>>=1}0==--l&&(l=Math.pow(2,h),h++),delete o[c]}else for(i=r[c],n=0;n<h;n++)p=p<<1|1&i,v==t-1?(v=0,f.push(s(p)),p=0):v++,i>>=1;0==--l&&(l=Math.pow(2,h),h++)}for(i=2,n=0;n<h;n++)p=p<<1|1&i,v==t-1?(v=0,f.push(s(p)),p=0):v++,i>>=1;for(;;){if(p<<=1,v==t-1){f.push(s(p));break}v++}return f.join("")},decompress:function(e){return null==e?"":""==e?null:a._decompress(e.length,32768,(function(t){return e.charCodeAt(t)}))},_decompress:function(t,s,n){var i,a,r,o,u,d,c,l=[],g=4,h=4,f=3,p="",v=[],R={val:n(0),position:s,index:1};for(i=0;i<3;i+=1)l[i]=i;for(r=0,u=Math.pow(2,2),d=1;d!=u;)o=R.val&R.position,R.position>>=1,0==R.position&&(R.position=s,R.val=n(R.index++)),r|=(o>0?1:0)*d,d<<=1;switch(r){case 0:for(r=0,u=Math.pow(2,8),d=1;d!=u;)o=R.val&R.position,R.position>>=1,0==R.position&&(R.position=s,R.val=n(R.index++)),r|=(o>0?1:0)*d,d<<=1;c=e(r);break;case 1:for(r=0,u=Math.pow(2,16),d=1;d!=u;)o=R.val&R.position,R.position>>=1,0==R.position&&(R.position=s,R.val=n(R.index++)),r|=(o>0?1:0)*d,d<<=1;c=e(r);break;case 2:return""}for(l[3]=c,a=c,v.push(c);;){if(R.index>t)return"";for(r=0,u=Math.pow(2,f),d=1;d!=u;)o=R.val&R.position,R.position>>=1,0==R.position&&(R.position=s,R.val=n(R.index++)),r|=(o>0?1:0)*d,d<<=1;switch(c=r){case 0:for(r=0,u=Math.pow(2,8),d=1;d!=u;)o=R.val&R.position,R.position>>=1,0==R.position&&(R.position=s,R.val=n(R.index++)),r|=(o>0?1:0)*d,d<<=1;l[h++]=e(r),c=h-1,g--;break;case 1:for(r=0,u=Math.pow(2,16),d=1;d!=u;)o=R.val&R.position,R.position>>=1,0==R.position&&(R.position=s,R.val=n(R.index++)),r|=(o>0?1:0)*d,d<<=1;l[h++]=e(r),c=h-1,g--;break;case 2:return v.join("")}if(0==g&&(g=Math.pow(2,f),f++),l[c])p=l[c];else{if(c!==h)return null;p=a+a.charAt(0)}v.push(p),l[h++]=a+p.charAt(0),a=p,0==--g&&(g=Math.pow(2,f),f++)}}};return a}();void 0===(n=function(){return i}.call(t,s,t,e))||(e.exports=n)},670:(e,t,s)=>{"use strict";s.r(t);var n={getItem:e=>new Promise(((t,s)=>{chrome.storage.local.get([e],(n=>{var i=chrome.runtime.lastError;i?s(`error when getting '${e}' from storage: ${i.message}`):t(n[e])}))})),setItem:(e,t)=>new Promise(((s,n)=>{chrome.storage.local.set({[e]:t},(()=>{var t=chrome.runtime.lastError;t?n(`error when setting value for '${e}' to storage: ${t.message}`):s()}))}))},i={setBadgeText({tabId:e,text:t}){chrome.action.setBadgeText({tabId:e,text:t},(()=>{var t=chrome.runtime.lastError;t&&console.log(`there was an error setting browser action badge text for tab ${e}: ${t.message}`)}))},setBadgeBackgroundColor({tabId:e,color:t}){chrome.action.setBadgeBackgroundColor({tabId:e,color:t},(()=>{var t=chrome.runtime.lastError;t&&console.log(`there was an error setting browser action background color for tab ${e}: ${t.message}`)}))}},a={createEditorUrl(e,t){var s=new URLSearchParams;e&&s.append("navigationId",e),t&&s.append("ruleId",t);const n=`create-rule.html?${s}`;var i=new URLSearchParams;return i.append("page",n),`sandbox.html?${i}`},getParamsFromHref(e){var t=new URL(e),s=t.searchParams.get("navigationId"),n=t.searchParams.get("ruleId");return{navigationId:s||void 0,ruleId:n?parseInt(n):void 0}},replaceParamsInHref(e,t,s){var n=new URL(e);return n.searchParams.delete("navigationId"),t&&n.searchParams.append("navigationId",t),n.searchParams.delete("ruleId"),s&&n.searchParams.append("ruleId",s),n.toString()}};const r={DELETE_ACTION_TYPE:"delete",REMOVE_CLASS_ACTION_TYPE:"removeClass",REMOVE_STYLE_PROPERTY_ACTION_TYPE:"removeStyleProperty",SELECT_ACTION_TYPE:"select",getDeleteActionDefinition(){return{type:this.DELETE_ACTION_TYPE}},getRemoveClassActionDefinition(e){return{type:this.REMOVE_CLASS_ACTION_TYPE,class:e}},getRemoveStylePropertyActionDefinition(e){return{type:this.REMOVE_STYLE_PROPERTY_ACTION_TYPE,property:e}},getSelectActionDefinition(e,t){return t||(t=this.getDeleteActionDefinition()),{type:this.SELECT_ACTION_TYPE,selector:e,action:t}},getSelectActionActionDefinitionOfType(e){switch(e){case this.DELETE_ACTION_TYPE:return this.getDeleteActionDefinition();case this.REMOVE_CLASS_ACTION_TYPE:return this.getRemoveClassActionDefinition();case this.REMOVE_STYLE_PROPERTY_ACTION_TYPE:return this.getRemoveStylePropertyActionDefinition()}},nodeActionsAreEqual(e,t){if(!e)return!t;if(!t)return!1;if(e.type!==t.type)return!1;switch(e.type){case this.DELETE_ACTION_TYPE:return!0;case this.REMOVE_CLASS_ACTION_TYPE:return e.class===t.class;case this.REMOVE_STYLE_PROPERTY_ACTION_TYPE:return e.property===t.property}},selectActionsAreEqual(e,t){return e.selector===t.selector&&this.nodeActionsAreEqual(e.action,t.action)},actionsAreEqual(e,t){if(!e)return!t;if(!t)return!1;if(e.type!==t.type)return!1;switch(e.type){case this.SELECT_ACTION_TYPE:return this.selectActionsAreEqual(e,t)}return!1},actionIsAchievedByOther(e,t){if(e.type!==t.type)return!1;switch(e.type){case this.DELETE_ACTION_TYPE:return!0;case this.REMOVE_CLASS_ACTION_TYPE:return e.class===t.class;case this.REMOVE_STYLE_PROPERTY_ACTION_TYPE:return e.property===t.property}},rulesAreEqual(e,t){if(!e)return!t;if(!t)return!1;if(e.name!==t.name||e.urlPattern!==t.urlPattern||e.automatic!==t.automatic)return!1;if(e.actions){if(!t.actions)return!1;if(e.actions.length!==t.actions.length)return!1;for(let s=0;s<e.actions.length;s++)if(!this.actionsAreEqual(e.actions[s],t.actions[s]))return!1;return!0}return!t.actions}};class o{constructor(e,t,s,n){this.navigation=e,this.inspectedWindow=t,this.editors=a,this.ruleDefinitions=r,this.page=n,this.rulesForUrlRequest=s.createChannel("requestRulesForUrl"),this.rulesForDownloadRequest=s.createChannel("requestRulesForDownload"),this.urlWithEncodedRuleRequest=s.createChannel("urlWithEncodedRuleRequest"),this.rulesJsonUploadRequest=s.createChannel("uploadRulesJson"),this.rulesForNavigationNotification=s.createChannel("notifyRulesForNavigation"),this.executeRuleMessage=s.createChannel("executeRule"),this.openEditorRequest=s.createChannel("openEditor"),this.ruleByIdRequest=s.createChannel("requestRuleById"),this.allRulesRequest=s.createChannel("requestAllRules"),this.executeActionRequest=s.createChannel("executeAction"),this.editedStatusRequest=s.createChannel("requestEditedStatus"),this.editableStatusRequest=s.createChannel("requestEditableStatus"),this.editorLoadedMessage=s.createChannel("editorLoaded"),this.editedStatusChangedMessage=s.createChannel("editedStatusChanged"),this.saveRuleRequest=s.createChannel("requestSaveRule"),this.deleteRuleRequest=s.createChannel("requestDeleteRule"),this.ruleAddedNotification=s.createChannel("notifyRuleAdded"),this.ruleDeletedNotification=s.createChannel("notifyRuleDeleted"),this.ruleUpdatedNotification=s.createChannel("notifyRuleUpdated"),this.addActionRequest=s.createChannel("requestToAddAction"),this.addSelectActionRequest=s.createChannel("requestToAddSelectAction"),this.addSelectActionToEditorRequest=s.createChannel("requestToAddSelectActionToEditor"),this.getSelectedElementInDevtoolsRequest=s.createChannel("getSelectedElementInDevtoolsRequest"),this.selectedElementInDevtoolsNotification=s.createChannel("selectedElementInDevtoolsNotification"),this.suggestionIndicationStartNotification=s.createChannel("suggestionIndicationStart"),this.suggestionIndicationEndNotification=s.createChannel("suggestionIndicationEnd"),this.executeSuggestionRequest=s.createChannel("executeSuggestion"),this.markSuggestionAsRemovedRequest=s.createChannel("markSuggestionAsRemoved"),this.undoSuggestionRequest=s.createChannel("undoSuggestion"),this.addSuggestionToRuleRequest=s.createChannel("addSuggestionToRuleRequest"),this.addSuggestionToNewRuleRequest=s.createChannel("addSuggestionToNewRuleRequest"),this.getAndRemoveSuggestionRequest=s.createChannel("getAndRemoveSuggestion"),this.getRuleStatesForNavigationRequest=s.createChannel("getRuleStatesForNavigation"),this.ruleStateForNavigationChangeNotification=s.createChannel("ruleStateForNavigationChangeNotification"),this.ruleStateForNavigationRemovedNotification=s.createChannel("ruleStateForNavigationRemovedNotification"),this.getSuggestionsRequest=s.createChannel("getSuggestions"),this.reloadSuggestionsRequest=s.createChannel("reloadSuggestions"),this.newDraftRuleForNavigationRequest=s.createChannel("newDraftRuleForNavigationRequest"),this.draftRuleCreatedNotification=s.createChannel("draftRuleCreatedNotification"),this.draftRulesRemovedNotification=s.createChannel("draftRulesRemovedNotification"),this.draftRuleForNavigationRequest=s.createChannel("draftRuleForNavigationRequest"),this.draftRuleStateForNavigationRequest=s.createChannel("draftRuleStateForNavigationRequest"),this.draftRuleStateForNavigationNotification=s.createChannel("draftRuleStateForNavigationNotification"),this.draftRuleChangedNotification=s.createChannel("draftRuleChangedNotification"),this.executeDraftRuleRequest=s.createChannel("executeDraftRuleRequest")}getRulesForUrl(e){return this.rulesForUrlRequest.target.sendMessageAsync(e)}getRuleById(e){return this.ruleByIdRequest.target.sendMessageAsync(e)}getRulesForDownload(e){return this.rulesForDownloadRequest.target.sendMessageAsync({ruleIds:e})}onGetRulesForDownloadRequest(e,t){return this.rulesForDownloadRequest.source.onMessage(e,t)}getUrlWithEncodedRule(e,t){return this.urlWithEncodedRuleRequest.target.sendMessageAsync({ruleId:e,navigationId:t})}onUrlWithEncodedRuleRequest(e,t){return this.urlWithEncodedRuleRequest.source.onMessage(e,t)}uploadRulesJson(e){return this.rulesJsonUploadRequest.target.sendMessageAsync({jsonString:e})}onUploadRulesJson(e,t){return this.rulesJsonUploadRequest.source.onMessage(e,t)}getAllRules(){return this.allRulesRequest.target.sendMessageAsync({})}onGetRuleByIdRequest(e,t){return this.ruleByIdRequest.source.onMessage(e,t)}onGetAllRulesRequest(e,t){return this.allRulesRequest.source.onMessage(e,t)}onRequestRulesForUrl(e,t){return this.rulesForUrlRequest.source.onMessage(e,t)}notifyRulesForNavigation(e){this.rulesForNavigationNotification.target.sendMessage(e)}onNotifyRulesForNavigation(e,t){return this.rulesForNavigationNotification.source.onMessage(e,t)}executeRuleAsync(e,t){return this.executeRuleMessage.target.sendMessageAsync({navigationId:e,ruleId:t})}onExecuteRuleRequest(e,t){return this.executeRuleMessage.source.onMessage(e,t)}executeActionAsync(e,t){return this.executeActionRequest.target.sendMessageAsync({navigationId:e,action:t})}onExecuteActionRequest(e,t){return this.executeActionRequest.source.onMessage(e,t)}onRequestToOpenEditor(e,t){return this.openEditorRequest.source.onMessage(e,t)}requestToOpenEditor({navigationId:e,ruleId:t}){return this.openEditorRequest.target.sendMessageAsync({navigationId:e,ruleId:t})}openManagementPage(){var e=new URLSearchParams;e.append("page","management.html"),this.navigation.openTab(`sandbox.html?${e}`)}getEditableStatus(e,t){return this.editableStatusRequest.target.sendMessageAsync({ruleId:e,navigationId:t})}onGetEditableStatusRequest(e,t){return this.editableStatusRequest.source.onMessage(e,t)}getEditedStatusAsync(e){return this.editedStatusRequest.target.sendMessageAsync({ruleId:e})}onEditedStatusChanged(e,t){return this.editedStatusChangedMessage.source.onMessage(e,t)}notifyEditedStatusChanged(e){this.editedStatusChangedMessage.target.sendMessage(e)}onEditedStatusRequest(e,t){return this.editedStatusRequest.source.onMessage(e,t)}onEditorLoaded(e,t){return this.editorLoadedMessage.source.onMessageFromNavigation(e,t)}notifyEditorLoaded(e){this.editorLoadedMessage.target.sendMessage(e)}saveRuleAsync(e){return this.saveRuleRequest.target.sendMessageAsync(e)}onSaveRuleRequest(e,t){return this.saveRuleRequest.source.onMessage(e,t)}deleteRuleAsync(e){return this.deleteRuleRequest.target.sendMessageAsync(e)}onDeleteRuleRequest(e,t){return this.deleteRuleRequest.source.onMessage(e,t)}notifyRuleAdded(){this.ruleAddedNotification.target.sendMessage({})}onRuleAdded(e,t){return this.ruleAddedNotification.source.onMessage(e,t)}notifyRuleDeleted(e){this.ruleDeletedNotification.target.sendMessage(e)}onRuleDeleted(e,t){return this.ruleDeletedNotification.source.onMessage(e,t)}notifyRuleUpdated(e){this.ruleUpdatedNotification.target.sendMessage(e)}onRuleUpdated(e,t){return this.ruleUpdatedNotification.source.onMessage(e,t)}requestToAddAction(e){this.addActionRequest.target.sendMessage(e)}onRequestToAddAction(e,t){return this.addActionRequest.source.onMessage(e,t)}addSelectAction(e,t,s){this.addSelectActionRequest.target.sendMessage({navigationId:e,selectorText:t,ruleId:s})}onRequestToAddSelectAction(e,t){return this.addSelectActionRequest.source.onMessage(e,t)}addSelectActionToEditor(e,t,s){this.addSelectActionToEditorRequest.target.sendMessage({navigationId:e,ruleId:t,selectorText:s})}onRequestToAddSelectActionToEditor(e,t){return this.addSelectActionToEditorRequest.source.onMessage(e,t)}getSelectedElementInDevtools(e){return this.getSelectedElementInDevtoolsRequest.target.sendMessageAsync({tabId:e})}onGetSelectedElementInDevtoolsRequest(e,t){return this.getSelectedElementInDevtoolsRequest.source.onMessage(e,t)}notifySelectedElementInDevtools(e){this.selectedElementInDevtoolsNotification.target.sendMessage(e)}onSelectedElementInDevtoolsChange(e,t){return this.selectedElementInDevtoolsNotification.source.onMessage(e,t)}notifySuggestionIndicationStart(e,t){this.suggestionIndicationStartNotification.target.sendMessage({navigationId:e,suggestionId:t})}onNotifySuggestionIndicationStart(e,t){return this.suggestionIndicationStartNotification.source.onMessage(e,t)}notifySuggestionIndicationEnd(e,t){this.suggestionIndicationEndNotification.target.sendMessage({navigationId:e,suggestionId:t})}onNotifySuggestionIndicationEnd(e,t){return this.suggestionIndicationEndNotification.source.onMessage(e,t)}onExecuteSuggestionRequest(e,t){return this.executeSuggestionRequest.source.onMessage(e,t)}executeSuggestion(e,t){return this.executeSuggestionRequest.target.sendMessageAsync({suggestionId:t,navigationId:e})}markSuggestionAsRemoved(e,t){return this.markSuggestionAsRemovedRequest.target.sendMessageAsync({navigationId:e,suggestionId:t})}onMarkSuggestionAsRemoved(e,t){return this.markSuggestionAsRemovedRequest.source.onMessage(e,t)}onUndoSuggestionRequest(e,t){return this.undoSuggestionRequest.source.onMessage(e,t)}undoSuggestion(e,t){return this.undoSuggestionRequest.target.sendMessageAsync({suggestionId:t,navigationId:e})}onAddSuggestionToRuleRequest(e,t){return this.addSuggestionToRuleRequest.source.onMessage(e,t)}requestToAddSuggestionToRule(e,t,s){this.addSuggestionToRuleRequest.target.sendMessage({ruleId:e,navigationId:t,suggestionId:s})}onAddSuggestionToNewRuleRequest(e,t){return this.addSuggestionToNewRuleRequest.source.onMessage(e,t)}requestToAddSuggestionToNewRule(e,t){this.addSuggestionToNewRuleRequest.target.sendMessage({navigationId:e,suggestionId:t})}onGetAndRemoveSuggestionRequest(e,t){return this.getAndRemoveSuggestionRequest.source.onMessage(e,t)}getSuggestions(e){return this.getSuggestionsRequest.target.sendMessageAsync({navigationId:e})}onGetSuggestionsRequest(e,t){return this.getSuggestionsRequest.source.onMessage(e,t)}reloadSuggestions(e){return this.reloadSuggestionsRequest.target.sendMessageAsync({navigationId:e})}onReloadSuggestionsRequest(e,t){return this.reloadSuggestionsRequest.source.onMessage(e,t)}getAndRemoveSuggestion(e,t){return this.getAndRemoveSuggestionRequest.target.sendMessageAsync({suggestionId:e,navigationId:t})}getRuleStatesForNavigation(e){return this.getRuleStatesForNavigationRequest.target.sendMessageAsync({navigationId:e})}onGetRuleStatesForNavigation(e,t){return this.getRuleStatesForNavigationRequest.source.onMessage(e,t)}notifyRuleStateForNavigationChanged(e,t){this.ruleStateForNavigationChangeNotification.target.sendMessage({navigationId:e,state:t})}onRuleStateForNavigationChanged(e,t){return this.ruleStateForNavigationChangeNotification.source.onMessage(e,t)}notifyRuleStateForNavigationRemoved(e,t){this.ruleStateForNavigationRemovedNotification.target.sendMessage({navigationId:e,ruleId:t})}onRuleStateForNavigationRemoved(e,t){return this.ruleStateForNavigationRemovedNotification.source.onMessage(e,t)}createNewDraftRuleForNavigation(e){return this.newDraftRuleForNavigationRequest.target.sendMessageAsync({navigationId:e})}onRequestToCreateNewDraftRuleForNavigation(e,t){return this.newDraftRuleForNavigationRequest.source.onMessage(e,t)}getDraftRuleForNavigation(e){return this.draftRuleForNavigationRequest.target.sendMessageAsync({navigationId:e})}onRequestDraftRuleForNavigation(e,t){return this.draftRuleForNavigationRequest.source.onMessage(e,t)}notifyDraftRuleCreated(e,t){this.draftRuleCreatedNotification.target.sendMessage({navigationId:e,draftRule:t})}onDraftRuleCreated(e,t){return this.draftRuleCreatedNotification.source.onMessage(e,t)}notifyDraftRulesRemoved(e){this.draftRulesRemovedNotification.target.sendMessage(e)}onDraftRulesRemoved(e,t){return this.draftRulesRemovedNotification.source.onMessage(e,t)}getDraftRuleStateForNavigation(e){return this.draftRuleStateForNavigationRequest.target.sendMessageAsync({navigationId:e})}onDraftRuleStateForNavigationRequest(e,t){return this.draftRuleStateForNavigationRequest.source.onMessage(e,t)}notifyDraftRuleStateForNavigation(e,t){this.draftRuleStateForNavigationNotification.target.sendMessage({navigationId:e,draftRuleState:t})}onDraftRuleStateForNavigation(e,t){return this.draftRuleStateForNavigationNotification.source.onMessage(e,t)}onRequestToExecuteDraftRule(e,t){return this.executeDraftRuleRequest.source.onMessage(e,t)}executeDraftRule(e){return this.executeDraftRuleRequest.target.sendMessageAsync({navigationId:e})}onDraftRuleChanged(e,t){return this.draftRuleChangedNotification.source.onMessage(e,t)}notifyDraftRuleChanged(e,t){this.draftRuleChangedNotification.target.sendMessage({navigationId:e,draftRule:t})}}class u{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class d{listen(e,t){this.addListener(e);var s=()=>this.removeListener(e);return t&&t.onCancelled(s),{cancel:s}}filter(e){return new v(this,e)}map(e){return new R(this,e)}mapAsync(e){return new h(this,e)}compare(e){return new c(this,e)}when(e,t){var s,n=new Promise((e=>{s=e})),i=this.listen((function(){var t=[].slice.apply(arguments);e.apply(null,t)&&(i.cancel(),s(t))}),t);return n}next(e){return this.when((()=>!0),e)}debounce(e){return new I(this,e)}}class c extends d{constructor(e,t){super(),this.source=e,this.getInitialArgs=t}listen(e,t){var s=this.getInitialArgs();return this.source.listen((function(){var t=Array.prototype.slice.apply(arguments),n=e(s,t);return s=t,n}),t)}}class l{constructor(e){this.source=e,this.listenersAndCancellationTokensAndSubscriptions=[]}cancelSubscriptionForListener(e){var t=this.removeListener(e);t&&t.subscription.cancel()}removeListener(e){var t=this.listenersAndCancellationTokensAndSubscriptions.findIndex((t=>t.listener===e));if(-1===t)return null;var[s]=this.listenersAndCancellationTokensAndSubscriptions.splice(t,1);return s}listen(e,t){var s=this.source.listen(e,t),n={listener:e,cancellationToken:t,subscription:s};return t&&t.onCancelled((()=>this.removeListener(e))),this.listenersAndCancellationTokensAndSubscriptions.push(n),{cancel:()=>this.cancelSubscriptionForListener(e)}}cancel(){for(let e of this.listenersAndCancellationTokensAndSubscriptions)e.subscription.cancel()}}class g extends d{constructor(e){super(),this.sourcesAndListeners=e.map((e=>new l(e))),this.listenersAndCancellationTokens=[]}removeListener(e){var t=this.listenersAndCancellationTokens.findIndex((t=>t.listener===e));-1!==t&&this.listenersAndCancellationTokens.splice(t,1)}addSource(e){var t=new l(e);for(let{listener:e,cancellationToken:s}of this.listenersAndCancellationTokens)t.listen(e,s);this.sourcesAndListeners.push(t)}removeSource(e){var t=this.sourcesAndListeners.findIndex((t=>t.source===e));if(-1!==t){var[s]=this.sourcesAndListeners.splice(t,1);s.cancel()}}listen(e,t){for(let s of this.sourcesAndListeners)s.listen(e,t);return t&&t.onCancelled((()=>this.removeListener(e))),this.listenersAndCancellationTokens.push({listener:e,cancellationToken:t}),{cancel:()=>{for(let t of this.sourcesAndListeners)t.cancelSubscriptionForListener(e);this.removeListener(e)}}}}class h extends d{constructor(e,t){super(),this.eventSource=e,this.mapAsync=t}listen(e,t){var s=this;return this.eventSource.listen((function(){var t=Array.prototype.slice.apply(arguments);s.mapAsync(...t).then((t=>{t?e(...t):e()}))}),t)}}class f extends d{constructor(e){super(),this.eventSource=e}listen(e,t){var s=this;return this.eventSource.listen((function(){var t=Array.prototype.slice.apply(arguments),n=s.map(...t);return e(...n)}),t)}}class p extends d{constructor(e){super(),this.eventSource=e}listen(e,t){var s=this;return this.eventSource.listen((function(){var t=Array.prototype.slice.apply(arguments);if(s.filter(...t))return e(...t)}),t)}}class v extends p{constructor(e,t){super(e),this.filter=t}}class R extends f{constructor(e,t){super(e),this.map=t}}class m extends d{constructor(){super(),this.listeners=[]}addListener(e){this.listeners.push(e)}removeListener(e){var t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}dispatch(){var e=Array.prototype.slice.apply(arguments);for(let t of this.listeners.slice())t(...e)}}class I extends m{constructor(e,t){super(),this.originalEventSource=e,this.interval=t,this.currentTimeout=void 0,this.subscription=void 0,this.latestArgs=void 0,this.waiting=!1}addListener(e){super.addListener(e),this.start()}removeListener(e){super.removeListener(e),0===this.listeners.length&&this.stop()}renewTimeout(){void 0!==this.currentTimeout&&clearTimeout(this.currentTimeout),this.currentTimeout=setTimeout((()=>{this.dispatch(...this.latestArgs),this.waiting=!1,this.currentTimeout=void 0}),this.interval),this.waiting=!0}start(){this.subscription=this.originalEventSource.listen(((...e)=>{this.latestArgs=e,this.renewTimeout()}))}stop(){void 0!==this.currentTimeout&&clearTimeout(this.currentTimeout),this.subscription&&this.subscription.cancel()}}class y extends m{constructor(){super(),this.cancelled=!1}dispatch(){if(!this.cancelled){this.cancelled=!0;for(let e of this.listeners)e();this.listeners=[]}}onCancelled(e){return this.listen(e)}cancel(){this.dispatch()}}class w{constructor(e){this.type=e}filterMessage(e){return e.type===this.type}unpackMessage(e){return e.message}packMessage(e){return{type:this.type,message:e}}toString(){return this.type}}class T{onMessage(e,t){return{cancel(){}}}nextMessage(e){var t=new u,s=this.onMessage((e=>{s.cancel(),t.resolve(e)}),e);return t.promise}ofType(e){return new S(this,e)}}class b{async sendMessageAsync(e){}sendMessage(e){}ofType(e){return new A(this,e)}}class S extends T{constructor(e,t){super(),this.messagesSource=e,this.messageType=t}onMessage(e,t){return this.messagesSource.onMessage(((t,s)=>{if(this.messageType.filterMessage(t))return e(this.messageType.unpackMessage(t),s)}),t)}}class A extends b{constructor(e,t){super(),this.messagesTarget=e,this.messageType=t}sendMessage(e){this.messagesTarget.sendMessage(this.messageType.packMessage(e))}sendMessageAsync(e){return this.messagesTarget.sendMessageAsync(this.messageType.packMessage(e))}}class N{constructor(e){this.loaded=!1,this.latestRuleId=0,this.rules=[],this.draftRules=[],this.ruleUpdated=new m,this.ruleAdded=new m,this.ruleDeleted=new m,this.draftRulesRemoved=new m,this.storage=e}async getDraftRuleForNavigation(e){await this.ensureLoaded();const t=this.draftRules.find((t=>t.navigationId===e));return t?t.rule:null}async pruneDraftRules(e){await this.ensureLoaded();const t=[],s=[];for(let n of this.draftRules)e.some((e=>e===n.navigationId))?t.push(n):s.push(n.navigationId);this.draftRules=t,await this.save(),s.length>0&&this.draftRulesRemoved.dispatch(s)}async updateDraftRuleForNavigation(e,t){await this.ensureLoaded();const s=this.draftRules.find((t=>t.navigationId===e));s&&(s.rule=t,await this.save())}async createDraftRuleForNavigation(e){await this.ensureLoaded();const t=new URL(e.url),s=t.hostname;let n=s,i=0;const a=this.draftRules.find((t=>t.navigationId===e.id)),r=this.rules.map((e=>e.name)).concat(this.draftRules.filter((e=>e!==a)).map((e=>e.rule.name)));for(;r.includes(n);)n=`${s} (${++i})`;const o={name:n,urlPattern:`${t.origin}/*`,actions:[]};return a?a.rule=o:this.draftRules.push({navigationId:e.id,rule:o}),await this.save(),o}async load(){this.rules=await this.storage.getItem("rules")||[],this.draftRules=await this.storage.getItem("draftRules")||[],this.rules.length>0&&(this.latestRuleId=Math.max.apply(Math,this.rules.map((e=>e.id)))),this.loaded=!0}async ensureLoaded(){this.loaded||await this.load()}async save(){await this.storage.setItem("rules",this.rules),await this.storage.setItem("draftRules",this.draftRules)}async deleteRule(e){await this.ensureLoaded();var t=this.rules.findIndex((t=>t.id===e));t>-1&&(this.rules.splice(t,1),this.ruleDeleted.dispatch({ruleId:e}),await this.save())}async saveRule(e){return await this.ensureLoaded(),void 0===e.id?await this.saveNewRule(e):(await this.updateRule(e),e.id)}async saveNewRuleIfNoEqualExists(e){await this.ensureLoaded();for(let t of this.rules)if(r.rulesAreEqual(t,e))return;return this.saveNewRule(e)}async saveNewRule(e){return e.id=++this.latestRuleId,this.rules.push(e),await this.save(),this.ruleAdded.dispatch(),e.id}async updateRule(e){if(void 0!==e.id){var t=this.rules.findIndex((t=>t.id==e.id));-1!=t&&(this.rules.splice(t,1),this.rules.push(e),await this.save(),this.ruleUpdated.dispatch({ruleId:e.id}))}}async getAll(){return await this.ensureLoaded(),this.rules.slice()}async getRule(e){return await this.ensureLoaded(),this.rules.find((t=>t.id===e))}async getRulesForDownload(e){await this.ensureLoaded();const t=[],s=this.rules.filter((t=>e.includes(t.id)));for(let e of s){const{id:s,...n}=e;t.push(n)}return t}async uploadRulesJson(e){let t;try{t=JSON.parse(e)}catch(e){return{error:e.toString()}}const s=function(e){if(!Array.isArray(e))return"The value is not an array";for(let t=0,s=e.length;t<s;t++){const s=e[t];if("object"!=typeof s)return`The value at position ${t} of the array is not an object`;const{automatic:n,name:i,urlPattern:a,actions:r}=s;if("boolean"!=typeof n)return`${JSON.stringify(n)} is not a valid value for 'automatic' (at position ${t} in the array)`;if("string"!=typeof i)return`${JSON.stringify(i)} is not a valid value for 'name' (at position ${t} in the array)`;if("string"!=typeof a)return`${JSON.stringify(a)} is not a valid value for 'urlPattern' (at position ${t} in the array)`;if(!Array.isArray(r))return`The provided value for 'actions' at position ${t} in the array is not an array`}return null}(t);if(s)return{error:s};await this.ensureLoaded();const n=[];for(let e of t){const t=++this.latestRuleId;e.id=t,this.rules.push(e),n.push(t)}return await this.save(),this.ruleAdded.dispatch(),{ruleIds:n}}async getRulesForUrl(e){return await this.ensureLoaded(),this.rules.filter((t=>function(e,t){var s=t.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/\*/g,"[\\S]*?"),n=new RegExp(`^${s}$`);return!!e.match(n)}(e,t.urlPattern)))}}class M{constructor(e,t,{numberOfRules:s,numberOfRulesThatHaveSomethingToDo:n,numberOfRulesThatHaveExecuted:i}){this.navigation=t,this.numberOfRules=s,this.numberOfRulesThatHaveSomethingToDo=n,this.numberOfRulesThatHaveExecuted=i,this.disappeared=new m,this.updated=new m,this.navigationInterface=e}update({numberOfRules:e,numberOfRulesThatHaveSomethingToDo:t,numberOfRulesThatHaveExecuted:s}){this.numberOfRules=e,this.numberOfRulesThatHaveSomethingToDo=t,this.numberOfRulesThatHaveExecuted=s,0===this.numberOfRules?this.disappear():this.updated.dispatch()}exists(){return this.navigationInterface.navigationExists(this.navigation.id)}disappear(){this.disappeared.dispatch()}serialize(){return{navigationId:this.navigation.id,numberOfRules:this.numberOfRules,numberOfRulesThatHaveSomethingToDo:this.numberOfRulesThatHaveSomethingToDo,numberOfRulesThatHaveExecuted:this.numberOfRulesThatHaveExecuted}}static create(e,t,{numberOfRules:s,...n}){return 0===s?null:new M(e,t,{numberOfRules:s,...n})}static async recreate(e,{navigationId:t,...s}){var n=await e.getNavigation(t);return n?new M(e,n,s):(console.log(`could not recreate notification for navigation '${t}'`),null)}}class E{constructor(e,t,s,n){this.tabId=s,this.notifications=n||[],this.disappeared=new m,this.cancellationToken=new y,this.navigationInterface=e,this.buttonInteraction=t;for(let e of this.notifications)this.addNotificationEventListeners(e)}addNotificationEventListeners(e){e.updated.listen((()=>{this.update()}),this.cancellationToken),e.disappeared.next(this.cancellationToken).then((()=>{this.removeNotification(e)}))}addNotification(e,t){var s=this.notifications.find((t=>t.navigation.id===e.id));if(s)s.update(t);else{if(!(s=M.create(this.navigationInterface,e,t)))return;this.notifications.push(s),this.addNotificationEventListeners(s)}this.update()}async prune(){await Promise.all(this.notifications.map((e=>this.removeNotificationIfNecessary(e)))),this.update()}removeNotification(e){var t=this.notifications.indexOf(e);t>-1&&(this.notifications.splice(t,1),this.update())}async removeNotificationIfNecessary(e){if(!await e.exists()){var t=this.notifications.indexOf(e);t>-1&&this.notifications.splice(t,1)}}disappear(){this.cancellationToken.cancel(),this.disappeared.dispatch()}update(){if(0===this.notifications.length)return this.buttonInteraction.setBadgeText({tabId:this.tabId,text:""}),void this.disappear();var e=this.notifications.map((e=>e.numberOfRules)).reduce(((e,t)=>e+t),0),t=this.notifications.map((e=>e.numberOfRulesThatHaveSomethingToDo)).reduce(((e,t)=>e+t),0),s=this.notifications.map((e=>e.numberOfRulesThatHaveExecuted)).reduce(((e,t)=>e+t),0);s>0?(this.buttonInteraction.setBadgeText({tabId:this.tabId,text:`${s}`}),this.buttonInteraction.setBadgeBackgroundColor({tabId:this.tabId,color:"#28a745"})):t>0?(this.buttonInteraction.setBadgeText({tabId:this.tabId,text:`${t}`}),this.buttonInteraction.setBadgeBackgroundColor({tabId:this.tabId,color:"#007bff"})):e>0&&(this.buttonInteraction.setBadgeText({tabId:this.tabId,text:`${e}`}),this.buttonInteraction.setBadgeBackgroundColor({tabId:this.tabId,color:"#6c757d"}))}serialize(){return{tabId:this.tabId,notifications:this.notifications.map((e=>e.serialize()))}}static create(e,t,s,n){if(null===M.create(e,s,n))return null;var i=new E(e,t,s.tabId);return i.addNotification(s,n),i}static async recreate(e,t,{tabId:s,notifications:n}){if(0===(n=(await Promise.all(n.map((t=>M.recreate(e,t))))).filter((e=>!!e))).length)return null;var i=new E(e,t,s,n);return i.update(),i}}class C{constructor(e,t,s){this.loaded=!1,this.buttons=[],this.navigationInterface=e,this.storage=t,this.buttonInteraction=s}async prune(){await this.ensureLoaded(),await Promise.all(this.buttons.map((e=>e.prune()))),this.save()}async ensureLoaded(){if(!this.loaded){var e=await this.storage.getItem("buttons")||[];this.buttons=(await Promise.all(e.map((e=>E.recreate(this.navigationInterface,this.buttonInteraction,e))))).filter((e=>!!e));for(let e of this.buttons)this.addButtonEventListeners(e);this.loaded=!0,this.save()}}addButtonEventListeners(e){e.disappeared.next().then((()=>{this.removeButton(e)}))}async addNotification({navigationId:e,...t}){await this.ensureLoaded();var s=await this.navigationInterface.getNavigation(e);if(s){var n=this.buttons.find((e=>e.tabId===s.tabId));if(n)n.addNotification(s,t);else{if(null===(n=E.create(this.navigationInterface,this.buttonInteraction,s,t)))return;this.buttons.push(n),this.addButtonEventListeners(n)}this.save()}else console.warn(`could not find navigation '${e}'`)}removeButton(e){var t=this.buttons.indexOf(e);t>-1&&(this.buttons.splice(t,1),this.save())}save(){this.storage.setItem("buttons",this.buttons.map((e=>e.serialize())))}}class q{constructor(e,t,s,n){this.otherNavigationId=n,this.ownNavigation=s,this.ruleId=t,this.navigationInterface=e}focus(){this.ownNavigation.focus()}serialize(){return{ruleId:this.ruleId,ownNavigationId:this.ownNavigation&&this.ownNavigation.id,otherNavigationId:this.otherNavigationId}}exists(){return this.navigationInterface.navigationExists(this.ownNavigation.id)}static async recreate(e,{ruleId:t,ownNavigationId:s,otherNavigationId:n}){var i=await e.getNavigation(s);return i?new q(e,t,i,n):null}}class x{constructor(e,t){this.loaded=!1,this.editors=[],this.editedStatusChanged=new m,this.navigationInterface=e,this.storage=t}save(){return this.storage.setItem("editors",this.editors.map((e=>e.serialize())))}async prune(){await this.ensureLoaded(),await Promise.all(this.editors.map((e=>this.removeEditorIfNecessary(e)))),await this.save()}async getNavigationsWithDraftRule(){return await this.ensureLoaded(),this.editors.filter((e=>void 0===e.ruleId&&void 0!==e.otherNavigationId)).map((e=>e.otherNavigationId))}async removeEditorIfNecessary(e){if(!await e.exists()){var t=this.editors.indexOf(e);-1!==t&&(this.editors.splice(t,1),this.editedStatusChanged.dispatch({ruleId:e.ruleId,edited:!1,otherNavigationId:e.otherNavigationId}))}}async tryToAddEditor({ruleId:e,ownNavigationId:t,otherNavigationId:s}){var n=await q.recreate(this.navigationInterface,{ruleId:e,ownNavigationId:t,otherNavigationId:s});n?this.addEditor(n):this.editedStatusChanged.dispatch({ruleId:e,edited:!1})}async ensureLoaded(){if(!this.loaded){var e=await this.storage.getItem("editors")||[];await Promise.all(e.map((e=>this.tryToAddEditor(e)))),this.loaded=!0}}addOpenedEditor(e,t,s){void 0!==e&&this.editors.some((t=>t.ruleId===e))||void 0===e&&this.editors.some((e=>e.otherNavigationId===s))||(this.addEditor(new q(this.navigationInterface,e,t,s)),this.editedStatusChanged.dispatch({ruleId:e,otherNavigationId:s,edited:!0}),this.save())}addEditor(e){this.editors.push(e)}async findEditor(e,t){if(await this.ensureLoaded(),void 0!==t){var s=this.editors.find((e=>e.ruleId===t));if(s)return s}else if(void 0!==e){var n=this.editors.find((t=>t.otherNavigationId===e));if(n)return n}return null}async createEditor(e,t){this.navigationInterface.openTab(a.createEditorUrl(e,t)),await this.editedStatusChanged.when((({ruleId:s,otherNavigationId:n,edited:i})=>i&&(void 0!==t&&s===t||n===e)))}async ensureEditorOpen(e,t){await this.findEditor(e,t)||await this.createEditor(e,t)}async openEditor({navigationId:e,ruleId:t}){const s=await this.findEditor(e,t);s?s.focus():await this.createEditor(e,t)}async getEditableStatus(e,t){await this.ensureLoaded();const s=this.editors.find((t=>t.ruleId===e));return!s||s.otherNavigationId===t}async getEditedStatus(e){await this.ensureLoaded();var t=this.editors.find((t=>t.ruleId===e));return t?{edited:!0,navigationId:t.otherNavigationId}:{edited:!1}}}var F=s(961);function L(e,t,s){return`${e}:${t}:${s}`}function D(e,t){return`${e}:${t}`}class O{constructor(e,t,s){this.id=L(e,t,s),this.historyId=D(e,t),this.url=s,this.tabId=e,this.frameId=t}focus(){chrome.tabs.update(this.tabId,{active:!0})}}const P=new w("getCurrentNavigation");function _(e){return e.createChannel("navigationReplaced")}class k{constructor(e,t,s,n){this.getCurrentNavigationMessageTarget=e.ofType(P),this.navigationReplacedMessage=t,this.navigationEventProvider=s,this.tabCollection=n}static createForBackground(e,t,s,n,i){const a=_(e);return s.navigationReplaced.listen((({navigationHistoryId:e,newNavigationId:t})=>{a.target.sendMessage({navigationHistoryId:e,newNavigationId:t})})),t.filter(((e,t)=>!!t.tab&&t.tab.id>0&&P.filterMessage(e))).listen(((e,t,s)=>{s({id:L(t.tab.id,t.frameId,t.url),historyId:D(t.tab.id,t.frameId),tabId:t.tab.id})})),new k(n,a,s,i)}static create(e,t,s,n){const i=_(e);return new k(t,i,s,n)}getCurrent(){return this.getCurrentNavigationMessageTarget.sendMessageAsync({})}openTab(e){this.tabCollection.openTab(e)}async navigationExists(e){const t=await this.tabCollection.getAllTabs();for(let s of t)if(L(s.id,0,s.url)===e)return!0;return await new Promise((async s=>{let n=!1;await Promise.all(t.map((async t=>{const i=await this.tabCollection.getAllFramesInTab(t.id);if(!n&&i)for(let a of i)if(L(t.id,a.frameId,a.url)===e){n=!0,s(!0);break}}))),n||s(!1)}))}async getNavigationsForTabId(e){const t=await this.tabCollection.getAllFramesInTab(e),s=[],n={};for(let i of t){if(!/^https?:\/\//.test(i.url))continue;let t=new URL(i.url).hostname;void 0!==n[t]?t=`${t} (${++n[t].count})`:n[t]={count:1},s.push({top:0===i.frameId,frameId:i.frameId,url:i.url,id:L(e,i.frameId,i.url),name:t})}return s}async getNavigationsForPopup(){const e=await this.tabCollection.getCurrentlyActiveTab();return await this.getNavigationsForTabId(e.id)}async getNavigation(e){const t=await this.tabCollection.getAllTabs();for(let s of t)if(L(s.id,0,s.url)===e)return new O(s.id,0,s.url);return await new Promise((async s=>{let n=!1;await Promise.all(t.map((async t=>{const i=await this.tabCollection.getAllFramesInTab(t.id);if(!n&&i)for(let a of i)if(L(t.id,a.frameId,a.url)===e){n=!0,s(new O(t.id,a.frameId,a.url));break}}))),n||s(null)}))}getPopupTabId(){return this.tabCollection.getPopupTabId()}onReplaced(e,t){return this.navigationReplacedMessage.source.onMessage(e,t)}onDisappeared(e,t){return this.navigationEventProvider.navigationDisappeared.listen(e,t)}onCreated(e,t){return this.navigationEventProvider.navigationCreated.listen(e,t)}whenDisappeared(e){return this.navigationEventProvider.navigationDisappeared.mapAsync((async()=>[await this.navigationExists(e)])).filter((e=>!e)).next()}}var U=new class extends d{addListener(e){chrome.tabs.onRemoved.addListener(e)}removeListener(e){chrome.tabs.onRemoved.removeListener(e)}},$=new class extends d{addListener(e){chrome.webNavigation.onCommitted.addListener(e)}removeListener(e){chrome.webNavigation.onCommitted.removeListener(e)}},B=new class extends d{addListener(e){chrome.webNavigation.onHistoryStateUpdated.addListener(e)}removeListener(e){chrome.webNavigation.onHistoryStateUpdated.removeListener(e)}},Y=new class extends d{addListener(e){chrome.webNavigation.onReferenceFragmentUpdated.addListener(e)}removeListener(e){chrome.webNavigation.onReferenceFragmentUpdated.removeListener(e)}},H=new g([B,Y]);class j extends b{constructor(e,t){super(),this.tabMessagesTargets=e,this.runtimeMessagesTarget=t,this.updated=new m}prune(e){this.tabMessagesTargets=this.tabMessagesTargets.filter((t=>-1!==e.indexOf(t.tabId)))}getTargets(){return[this.runtimeMessagesTarget].concat(this.tabMessagesTargets)}sendMessageAsync(e){return new Promise((t=>{var s=this.getTargets();for(let n of s)n.sendMessageAsync(e).then((e=>t(e)),(e=>{}))}))}sendMessage(e){for(var t of this.getTargets())t.sendMessage(e)}serialize(){return this.tabMessagesTargets.map((e=>e.tabId))}addTarget(e){this.tabMessagesTargets.some((t=>t.tabId===e.tabId))||(this.tabMessagesTargets.push(e),this.updated.dispatch())}static create(e,t,s){const n=e.map((e=>s.createTarget(e)));return new j(n,t)}}class J{constructor(e,t,s,n){this.storage=e,this.tabCollection=t,this.runtimeMessagesTarget=s,this.tabMessagesTargetFactory=n,this.loaded=!1,this.subscriptions={}}async pruneSubscriptions(){this.ensureLoaded();const e=(await this.tabCollection.getAllTabs()).map((e=>e.id));for(let t of Object.getOwnPropertyNames(this.subscriptions)){const s=this.subscriptions[t];s&&s.prune(e)}this.save()}async ensureLoaded(){if(this.loaded)return;const e=await this.storage.getItem("crossBoundarySubscriptions");if(e)for(let t of Object.getOwnPropertyNames(e)){const s=j.create(e[t],this.runtimeMessagesTarget,this.tabMessagesTargetFactory);s.updated.listen((()=>this.save())),this.subscriptions[t]=s}this.loaded=!0}async save(){await this.storage.setItem("crossBoundarySubscriptions",this.serialize())}serialize(){const e={};for(let t of Object.getOwnPropertyNames(this.subscriptions)){const s=this.subscriptions[t];if(!s)continue;const n=s.serialize();e[t]=n}return e}async addTargetForType(e,t){await this.ensureLoaded();let s=this.subscriptions[e];s||(s=new j([],this.runtimeMessagesTarget),s.updated.listen((()=>this.save())),this.subscriptions[e]=s),s.addTarget(t)}async getTargetForType(e){return await this.ensureLoaded(),this.subscriptions[e]||new j([],this.runtimeMessagesTarget)}}class G{constructor(e,t){this.target=e,this.source=t}}var W=new w("crossBoundarySubscription"),z=new w("requestTarget");class V extends b{constructor(e,t){super(),this.type=e,this.messageType=new w(e),this.subscriptionCollection=t}async getTarget(){return(await this.subscriptionCollection.getTargetForType(this.type)).ofType(this.messageType)}sendMessage(e){this.getTarget().then((t=>t.sendMessage(e)))}async sendMessageAsync(e){return(await this.getTarget()).sendMessageAsync(e)}}class K extends b{constructor(e,t,s,n){super(),this.targetRequestTarget=t,this.type=e,this.messageType=new w(e),this.runtimeMessagesTarget=s,this.tabMessagesTargetFactory=n}async getTarget(){const e=await this.targetRequestTarget.sendMessageAsync({type:this.type});return j.create(e,this.runtimeMessagesTarget,this.tabMessagesTargetFactory).ofType(this.messageType)}sendMessage(e){this.getTarget().then((t=>t.sendMessage(e)))}async sendMessageAsync(e){var t=await this.getTarget();return await t.sendMessageAsync(e)}}class Q extends T{constructor(e,t,s){super();const n=new w(e);this.source=s.ofType(n),this.messageFromNavigationSource=t.navigationMessages.filter((e=>n.filterMessage(e))).map(((e,t,s)=>[n.unpackMessage(e),t,s]))}onMessage(e,t){return this.source.onMessage(e,t)}onMessageFromNavigation(e,t){return this.messageFromNavigationSource.listen(e,t)}}class X extends T{constructor(e,t,s,n){super();const i=new w(e);this.type=e,this.source=s.ofType(i),this.messageFromNavigationSource=t.navigationMessages.filter((e=>i.filterMessage(e))).map(((e,t,s)=>[i.unpackMessage(e),t,s])),this.subscriptionMessageTarget=n}onMessage(e,t){return this.subscriptionMessageTarget.sendMessage({messageType:this.type}),this.source.onMessage(e,t)}onMessageFromNavigation(e,t){return this.messageFromNavigationSource.listen(e,t)}}class Z{constructor(e,t,s){this.subscriptionCollection=e,this.navigationEventProvider=t,this.runtimeMessagesSource=s}createChannel(e){const t=new V(e,this.subscriptionCollection),s=new Q(e,this.navigationEventProvider,this.runtimeMessagesSource);return new G(t,s)}}class ee{constructor(e,t,s,n,i,a){this.targetRequestTarget=e,this.runtimeMessagesTarget=t,this.runtimeMessagesSource=s,this.navigationEventProvider=n,this.subscriptionMessageTarget=i,this.tabMessagesTargetFactory=a}createChannel(e){const t=new K(e,this.targetRequestTarget,this.runtimeMessagesTarget,this.tabMessagesTargetFactory),s=new X(e,this.navigationEventProvider,this.runtimeMessagesSource,this.subscriptionMessageTarget);return new G(t,s)}}const te=chrome.runtime.id;class se extends b{constructor(e){super(),this.tabId=e}sendMessage(e){chrome.tabs.sendMessage(this.tabId,e)}sendMessageAsync(e){return new Promise(((t,s)=>{chrome.tabs.sendMessage(this.tabId,e,(n=>{var i=chrome.runtime.lastError;i?s(`error when sending message to tab ${this.tabId}. Message: ${JSON.stringify(e)}. Error: ${i.message}`):t(n)}))}))}}const ne=new class{createTarget(e){return new se(e)}},ie=new class extends d{addListener(e){chrome.runtime.onMessage.addListener(e)}removeListener(e){chrome.runtime.onMessage.removeListener(e)}},ae=new class extends T{constructor(e){super(),this.source=e.map(((e,t,s)=>[e,s]))}onMessage(e,t){return this.source.listen(e,t)}}(ie),re=new class extends b{sendMessageAsync(e){return new Promise(((t,s)=>{chrome.runtime.sendMessage(void 0,e,(n=>{var i=chrome.runtime.lastError;i?s(`error when sending message. Message: ${JSON.stringify(e)}. Error: ${i.message}`):t(n)}))}))}sendMessage(e){chrome.runtime.sendMessage(void 0,e)}},oe=new class{isExtension(e){return e.origin===`chrome-extension://${te}`}},ue=new class{openTab(e){chrome.tabs.create({url:e})}getAllTabs(){return new Promise((e=>chrome.tabs.query({},e)))}getAllFramesInTab(e){return new Promise((t=>chrome.webNavigation.getAllFrames({tabId:e},t)))}getCurrentlyActiveTab(){return new Promise(((e,t)=>{chrome.tabs.query({active:!0,currentWindow:!0},(s=>{1===s.length?e(s[0]):t(new Error(`looked for the single active tab, but found ${s.length} tabs`))}))}))}getPopupTabId(){return new Promise(((e,t)=>{chrome.tabs.query({lastFocusedWindow:!0,active:!0},(s=>{1===s.length?e(s[0].id):t(new Error(`looked for the single active tab, but found ${s.length} tabs`))}))}))}tabExists(e){return new Promise((t=>{chrome.tabs.get(e,(e=>{var s=chrome.runtime.lastError;t(!!e&&!s)}))}))}},de=new class{constructor(e,t,s,n){this.navigationCreated=s.map((({tabId:e,frameId:t,url:s})=>[new O(e,t,s)])),this.navigationMessages=e.filter(((e,t)=>!!t.tab&&t.tab.id>0)).map(((e,{frameId:t,tab:s,url:n},i)=>[e,new O(s.id,t,s.url),i])),this.navigationReplaced=n.map((({tabId:e,frameId:t,url:s})=>[{navigationHistoryId:D(e,t),newNavigationId:L(e,t,s)}])),this.navigationDisappeared=new g([s,t,n])}}(ie,U,$,H),ce=class{static createForBackground(e,t,s,n,i,a,r,o,u){const d=new J(e,t,n,u);return s.filter(((e,t)=>W.filterMessage(e)&&!a.isExtension(t))).map(((e,t)=>[W.unpackMessage(e),u.createTarget(t.tab&&t.tab.id)])).listen((({messageType:e},t)=>{d.addTargetForType(e,t)})),r.listen((()=>d.pruneSubscriptions())),i.ofType(z).onMessage((({type:e},t)=>(d.getTargetForType(e).then((e=>t(e.serialize()))),!0))),new Z(d,o,i)}static create(e,t,s,n){const i=e.ofType(z),a=e.ofType(W);return new ee(i,e,t,s,a,n)}}.createForBackground(n,ue,ie,re,ae,oe,U,de,ne);!function(e,t,s,n,i){var a,r,u=new o(n,void 0,i),d=new N(t),c=new x(n,t),l=new C(n,t,s);a="sandbox.html?page=popup.html",void 0!==r?chrome.action.setPopup({tabId:r,popup:a}):chrome.action.setPopup({popup:a}),n.onCreated((async e=>{const t=function(e){const t=new URL(e).hash.match(/toolrule(.*)$/);if(!t)return null;const s=t[1];try{const e=(0,F.decompressFromEncodedURIComponent)(s);return JSON.parse(e)}catch(e){return null}}(e.url);t&&await d.saveNewRuleIfNoEqualExists(t)})),n.onDisappeared((async()=>{await c.prune();const e=await c.getNavigationsWithDraftRule();await d.pruneDraftRules(e),await l.prune()})),u.onRequestRulesForUrl(((e,t)=>(d.getRulesForUrl(e).then(t),!0))),u.onGetRulesForDownloadRequest((({ruleIds:e},t)=>(d.getRulesForDownload(e).then(t),!0))),u.onUrlWithEncodedRuleRequest((({ruleId:e,navigationId:t},s)=>(async function(e,t){const[s,i]=await Promise.all([d.getRule(e),n.getNavigation(t)]);return function(e,t){const{id:s,...n}=e,i=(0,F.compressToEncodedURIComponent)(JSON.stringify(n)),a=new URL(t),r=a.hash.replace(/^#/,"").replace(/toolrule.*$/,"");return a.hash=`${r}toolrule${i}`,a.toString()}(s,i.url)}(e,t).then(s),!0))),u.onUploadRulesJson((({jsonString:e},t)=>(d.uploadRulesJson(e).then(t),!0))),u.onNotifyRulesForNavigation((e=>{l.addNotification(e)})),u.onRequestToOpenEditor(((e,t)=>(c.openEditor(e).then((()=>{t({})})),!0))),u.onEditedStatusRequest((({ruleId:e},t)=>(c.getEditedStatus(e).then((e=>t(e))),!0))),u.onGetEditableStatusRequest((({ruleId:e,navigationId:t},s)=>(c.getEditableStatus(e,t).then(s),!0))),u.onGetRuleByIdRequest(((e,t)=>(d.getRule(e).then(t),!0))),u.onGetAllRulesRequest(((e,t)=>(d.getAll().then(t),!0))),u.onSaveRuleRequest(((e,t)=>(d.saveRule(e).then(t),!0))),u.onDeleteRuleRequest(((e,t)=>(d.deleteRule(e).then(t),!0))),u.onEditorLoaded((({ruleId:e,otherNavigationId:t},s)=>{c.addOpenedEditor(e,s,t)})),u.onAddSuggestionToNewRuleRequest((async({navigationId:e,suggestionId:t})=>{const s=await u.getAndRemoveSuggestion(t,e);await c.ensureEditorOpen(e),u.requestToAddAction({navigationId:e,actionDefinition:s.actionDefinition})})),u.onRequestToAddSelectAction((async({navigationId:e,selectorText:t,ruleId:s})=>{await c.openEditor({navigationId:e,ruleId:s}),u.addSelectActionToEditor(e,s,t)})),u.onAddSuggestionToRuleRequest((async({ruleId:e,navigationId:t,suggestionId:s})=>{const n=await u.getAndRemoveSuggestion(s,t),i=await d.getRule(e);i.actions.push(n.actionDefinition),d.saveRule(i)})),u.onRequestToCreateNewDraftRuleForNavigation((({navigationId:e},t)=>(n.getNavigation(e).then((s=>{s?d.createDraftRuleForNavigation(s).then((s=>{t(s),u.notifyDraftRuleCreated(e,s)})):t({})})),!0))),u.onRequestDraftRuleForNavigation((({navigationId:e},t)=>(d.getDraftRuleForNavigation(e).then((e=>{t(e)})),!0))),u.onDraftRuleChanged((({navigationId:e,draftRule:t})=>{d.updateDraftRuleForNavigation(e,t)})),d.ruleAdded.listen((()=>{u.notifyRuleAdded()})),d.ruleDeleted.listen((e=>{u.notifyRuleDeleted(e)})),d.ruleUpdated.listen((e=>{u.notifyRuleUpdated(e)})),d.draftRulesRemoved.listen((e=>{u.notifyDraftRulesRemoved(e)})),c.editedStatusChanged.listen((({ruleId:e,otherNavigationId:t,edited:s})=>{u.notifyEditedStatusChanged({ruleId:e,otherNavigationId:t,edited:s})}))}(0,n,i,k.createForBackground(ce,ie,de,re,ue),ce)}},t={};function s(n){if(t[n])return t[n].exports;var i=t[n]={exports:{}};return e[n](i,i.exports,s),i.exports}return s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s(670)})()}));